function GetRequest(a){var e=window.parent.location.search||_win.url_request||"";if(-1!=e.indexOf("?")){var i=e.substr(1);i.indexOf(!0)&&(i=i.substr(0)),strs=i.split("&");for(var n=0;n<strs.length;n++)if(-1!=strs[n].indexOf(a))return strs[n].split("=")[1]}return null}function delQueStr(a,e){var i="";if(e=e||window.location.href,-1==e.indexOf("?"))return e;i=e.substr(e.indexOf("?")+1);var n="",t="";if(-1!=i.indexOf("&")){for(var o in n=i.split("&"),n)n[o].split("=")[0]!=a&&(t=t+n[o].split("=")[0]+"="+n[o].split("=")[1]+"&");return e.substr(0,e.indexOf("?"))+"?"+t.substr(0,t.length-1)}return n=i.split("="),n[0]==a?e.substr(0,e.indexOf("?")):e}(function(a){function e(){var e='<div class="modal fade flex jc" style="display:none;" id="'+g+'" tabindex="-1" role="dialog" aria-hidden="false">        <div class="modal-dialog" role="document">            <div class="pay-payment alipay">                <div class="modal-body modal-pay-body">                    <div class="row-5 hide-sm">                        <img class="lazyload pay-sys t-wechat" alt="alipay" src="" data-src="'+u.uri+'/zibpay/assets/img/alipay-sys.png">                        <img class="lazyload pay-sys t-alipay" alt="wechat" src="" data-src="'+u.uri+'/zibpay/assets/img/wechat-sys.png">                    </div>                    <div class="row-5">                    <div class="pay-qrcon">                        <div class="qrcon">                            <div class="pay-logo-header mb10"><span class="pay-logo"></span><span class="pay-logo-name t-wechat">支付宝</span><span class="pay-logo-name t-alipay">微信支付</span></div>                            <div class="pay-title em09 muted-2-color padding-h6"></div>                            <div><span class="em09">￥</span><span class="pay-price em14"></span></div>                            <div class="pay-qrcode">                                <img src="" alt="pay-qrcode">                            </div>                        </div>                    <div class="pay-switch"></div>                    <div class="pay-notice"><div class="notice load">正在生成订单，请稍候</div></div>                    </div>\t\t\t\t</div>                </div>            </div>        </div>    </div>';a("link#zibpay_css").length||a("head").append('<link type="text/css" id="zibpay_css" rel="stylesheet" href="'+u.uri+"/zibpay/assets/css/main.css?ver="+u.ver+'">'),a("#"+g).length||m.append(e),a(document).ready(l),m.on("click",".initiate-pay",s),m.on("click",".pay-vip",p),m.on("click",".coupon-submit",n),m.on("hide.bs.modal","#"+g,function(){y.order_num=!1,f=!1}),v=a("#"+g)}function i(a){var e=a.find(".actual-price-number");if(e.length){var i=parseFloat(e.data("price"));e.text(i)}a.find(".coupon-data-box").html(""),a.find('input[name="coupon"]').val("")}function n(){var e=a(this),i=e.parents(".coupon-input-box").find('input[name="coupon"]'),n=e.parents("form"),t=n.serializeObject(),o=e.parents(".coupon-input-box").find(".coupon-data-box");if(t.action="coupon_submit",!t.coupon)return notyf("请输入优惠码","warning"),!1;var s=n.find(".actual-price-number"),d=0;return s.length&&(d=parseFloat(s.data("price")),s.text(d)),o.html(""),zib_ajax(e,t,function(a){a.error&&i.val("");var e="";"subtract"==a.discount.type?(e='<span class="muted-2-color">优惠立减</span><span class="font-bold c-red em14">-'+a.discount.val+"</span>",d&&(d=(d-a.discount.val).toFixed(2))):"multiply"==a.discount.type&&(d?(e='<span class="c-red">'+10*a.discount.val+'折优惠</span><span class="font-bold c-red em14">-'+parseFloat((d*(1-a.discount.val)).toFixed(2))+"</span>",d=(d*a.discount.val).toFixed(2)):e='<span class="muted-2-color">优惠</span><span class="font-bold c-red em14">'+10*a.discount.val+"折</span>"),e=e?'<div class="discount-box flex jsb ab">'+e+"</div>":"",a.expire_time&&(e+='<div class="coupon-time flex jsb ab"><span class="muted-2-color">有效期至</span><span class="muted-color">'+a.expire_time+"</span></div>");var n='<div class="mt10 coupon-box mb10 muted-box padding-h6 line-16"><div><span class="badg badg-sm mr6 jb-blue">优惠码可用</span>'+(a.title?"<span>"+a.title+"</span>":"")+"</div>"+e+"</div>";o.html(n),s.length&&(d=d<0?0:parseFloat(d),s.text(d))},"stop"),!1}function t(e,n){e.openid&&notyf("正在发起支付，请稍后...","load","","pay_ajax"),zib_ajax(n,e,function(t){if(t.error_code&&"coupon_error"==t.error_code&&i(n.parents("form")),!t.error){if(t.url&&t.open_url)return window.location.href=t.url,window.location.reload,void notyf("正在跳转到支付页面");if(t.form_html)return m.append(t.form_html),void notyf("正在跳转到支付页面");if(t.jsapiParams){var s=t.jsapiParams,l=t.jsapi_return||0;return"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",r(s,l),!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",r(s,l)),document.attachEvent("onWeixinJSBridgeReady",r(s,l))):r(s,l),void notyf("请完成支付","","",e.openid?"pay_ajax":"")}t.url_qrcode&&(v.find(".more-html").remove(),a(".modal:not(#"+g+")").modal("hide"),v.find(".pay-qrcode img").attr("src",t.url_qrcode),d("请扫码支付，支付成功后会自动跳转",""),t.more_html&&v.find(".pay-notice").before('<div class="more-html">'+t.more_html+"</div>"),t.order_name&&v.find(".pay-title").html(t.order_name),t.order_price&&v.find(".pay-price").html(t.order_price),t.payment_method&&v.find(".pay-payment").removeClass("wechat alipay").addClass(t.payment_method),v.modal("show"),y=t,f||(o(),f=!0))}},"stop")}function o(){y.order_num&&a.ajax({type:"POST",url:_,data:{action:"check_pay",order_num:y.order_num,check_sdk:y.check_sdk},dataType:"json",success:function(a){"1"==a.status?(d("支付成功，页面跳转中","success"),setTimeout(function(){void 0!==h.return_url&&h.return_url?(window.location.href=delQueStr("openid",delQueStr("zippay",h.return_url)),window.location.reload):(location.href=delQueStr("openid",delQueStr("zippay")),location.reload)},300)):setTimeout(function(){o()},2e3)}})}function s(){var e=a(this),i=e.parents("form");return h=i.serializeObject(),h.action="initiate_pay",h.return_url||(h.return_url=window.location.href),t(h,e),!1}function d(a,e){var i=v.find(".pay-notice .notice");a="load"==e?'<i class="loading mr6"></i>'+a:a,i.removeClass("load warning success danger").addClass(e).html(a)}function r(a,e){WeixinJSBridge.invoke("getBrandWCPayRequest",a,function(a){var i=delQueStr("openid",delQueStr("zippay"));if("get_brand_wcpay_request:ok"==a.err_msg&&e)return location.href=e,void location.reload;location.href=i,location.reload})}function l(){var e=GetRequest("zippay"),i=GetRequest("openid");e&&i&&c()&&(h.pay_type="wechat",h.openid=i,h.action="initiate_pay",t(h,a("<div></div>")))}function c(){var a=window.navigator.userAgent.toLowerCase();return"micromessenger"==a.match(/MicroMessenger/i)}function p(){var e=a(this),i='<div class="modal fade flex jc" id="modal_pay_uservip" tabindex="-1" role="dialog" aria-hidden="false">    <div class="modal-dialog" role="document">    <div class="modal-content">    <div class="modal-body"><h4 style="padding:20px;" class="text-center"><i class="loading zts em2x"></i></h4></div>    </div>    </div>    </div>    </div>';a("#modal_pay_uservip").length||m.append(i);var n=a("#modal_pay_uservip"),t=e.attr("vip-level")||1;return n.find(".payvip-modal").length?(a('a[href="#tab-payvip-'+t+'"]').tab("show"),n.modal("show")):(notyf("加载中，请稍等...","load","","payvip_ajax"),a.ajax({type:"POST",url:_,data:{action:"pay_vip",vip_level:t},dataType:"json",success:function(e){var i=e.msg||"请选择会员选项";-1!=i.indexOf("登录")&&(n.remove(),a(".signin-loader:first").click()),notyf(i,e.ys?e.ys:e.error?"danger":"",3,"payvip_ajax"),e.error||(n.find(".modal-content").html(e.html),n.find(".modal-content .tab-pane.active").length||n.find('.modal-content a[data-toggle="tab"]:eq(0)').click(),n.trigger("loaded.bs.modal").modal("show"),auto_fun())}})),!1}var u=window._win,m=a("body"),v=!1,f=!1,y={},h={},_=u.ajax_url,g="zibpay_modal";e();var b='[data-controller="payment_method"][data-value="card_pass"]';m.on("controller.change",b,function(e,i){var n=a(this),t=n.parents("form");i?t.find(".charge-box").hide():t.find(".charge-box").show()}),m.on("loaded.bs.modal","#refresh_modal",function(){a(this).find(b).length&&a(this).find('input[name="payment_method"]').trigger("change")})})(jQuery);